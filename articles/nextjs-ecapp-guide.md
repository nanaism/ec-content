---
title: "Next.js 15 ã¨ Auth.js v5, Stripeã§ä½œã‚‹ï¼ãƒ¢ãƒ€ãƒ³ãªãƒ‡ã‚¸ã‚¿ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è²©å£²ã‚µã‚¤ãƒˆæ§‹ç¯‰ã‚¬ã‚¤ãƒ‰"
emoji: "ğŸ›’"
type: "tech"
topics: ["nextjs", "react", "authjs", "stripe", "prisma", "typescript"]
published: true
---

## ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢2å¹´ç›®ã®ogaã§ã™ã€‚
Reactã¨Next.jsã®åŸºæœ¬ã‚’ãªã‚“ã¨ãªãç†è§£ã—ã¦ã€ã€Œæ¬¡ã¯ä½•ã‚’ä½œã‚ã†ã‹ãªâ€¦ã€ã€ŒãŸã ã®Todoã‚¢ãƒ—ãƒªã˜ã‚ƒç‰©è¶³ã‚Šãªã„ãªâ€¦ã€ã¨æ‚©ã‚“ã§ã„ãŸæ™‚æœŸãŒã€çš†ã•ã‚“ã«ã‚‚ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã‹ï¼Ÿ 

ãã‚“ãªæ™‚ã€ãµã¨æ€ã£ãŸã‚“ã§ã™ã€‚

ã€Œè‡ªåˆ†ã®çŸ¥è­˜ã‚„çµŒé¨“ã‚’ã€ãƒ‡ã‚¸ã‚¿ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦è²©å£²ã—ã¦ã¿ãŸã„ã€
ã€ŒZennã‚„noteã¿ãŸã„ãªã€æ´—ç·´ã•ã‚ŒãŸãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªåˆ†ã®æ‰‹ã§ä½œã‚ŒãŸã‚‰ã€æœ€é«˜ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«ãªã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ï¼Ÿã€

ã‚‚ã—ã‚ãªãŸãŒåƒ•ã¨åŒã˜ã‚ˆã†ã«ã€å­¦ã‚“ã çŸ¥è­˜ã‚’æ´»ã‹ã—ã¦**å®Ÿè·µçš„ã§ä¾¡å€¤ã®ã‚ã‚‹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª**ã‚’ä½œã‚ŠãŸã„ã¨è€ƒãˆã¦ã„ã‚‹ãªã‚‰ã€ã“ã®è¨˜äº‹ã¯ã¾ã•ã«ãã®ãŸã‚ã®ç¾…é‡ç›¤ã«ãªã‚‹ã¯ãšã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€å˜ãªã‚‹æŠ€è¡“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§çµ‚ã‚ã‚Šã¾ã›ã‚“ã€‚**ãƒ‡ã‚¸ã‚¿ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæŠ€è¡“è¨˜äº‹ã‚„é›»å­æ›¸ç±ï¼‰ã‚’è²©å£²ã™ã‚‹ECã‚µã‚¤ãƒˆã‚’ã‚¼ãƒ­ã‹ã‚‰æ§‹ç¯‰ã™ã‚‹**ã¨ã„ã†ã€ä¸€ã¤ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºã‚’ä¸¸ã”ã¨ä½“é¨“ã—ã¦ã„ãŸã ãã¾ã™ã€‚ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€èªè¨¼ã‚„æ±ºæ¸ˆã¨ã„ã£ãŸã€ã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºã®æ ¹å¹¹ã«é–¢ã‚ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹çµŒé¨“ã¯ã€é–“é•ã„ãªãã‚ãªãŸã®å¸‚å ´ä¾¡å€¤ã‚’æŠ¼ã—ä¸Šã’ã¦ãã‚Œã‚‹ã¯ãšã§ã™ã€‚

### å®Œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸

ã“ã®ã‚¬ã‚¤ãƒ‰ã‚’æœ€å¾Œã¾ã§é€²ã‚ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œæˆã—ã¾ã™ã€‚

*   **ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼**: ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆGitHubï¼‰ã«ã‚ˆã‚‹ç°¡å˜ã§å®‰å…¨ãªä¼šå“¡ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã€‚
*   **ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†**: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«é¦´æŸ“ã¿æ·±ã„Markdownå½¢å¼ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åŸ·ç­†ãƒ»ç®¡ç†ã€‚
*   **ç„¡æ–™ãƒ»æœ‰æ–™è¨­å®š**: è¨˜äº‹ã‚„æœ¬ã”ã¨ã«ã€ç„¡æ–™å…¬é–‹ã¾ãŸã¯æœ‰æ–™è²©å£²ã‚’è¨­å®šå¯èƒ½ã€‚
*   **ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆ**: Stripeã¨é€£æºã—ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å®‰å…¨ãªæ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã‚’å®Ÿç¾ã€‚
*   **è³¼å…¥æ¸ˆã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é–²è¦§**: ä¸€åº¦è³¼å…¥ã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã€ã„ã¤ã§ã‚‚è‡ªç”±ã«é–²è¦§ã§ãã‚‹ã€‚

ã“ã®æ—…è·¯ã‚’çµ‚ãˆã‚‹é ƒã«ã¯ã€ã‚ãªãŸã¯ä»¥ä¸‹ã®å¼·åŠ›ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã‚’è‡ªåœ¨ã«æ“ã‚Šã€è¤‡é›‘ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ç¢ºã‹ãªè‡ªä¿¡ã‚’æ‰‹ã«ã—ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚åƒ•è‡ªèº«ã€ã“ã®é–‹ç™ºã‚’é€šã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„Server Actionsã®æœ¬å½“ã®é­…åŠ›ã‚’ç†è§£ã§ããŸã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

## ã“ã®ã‚¬ã‚¤ãƒ‰ã§æ·±ãå­¦ã¹ã‚‹ã“ã¨

æœ¬ã‚¬ã‚¤ãƒ‰ã®æ ¸å¿ƒã¨ãªã‚‹ãƒ†ãƒ¼ãƒã¯ã€ãƒ¢ãƒ€ãƒ³ãªWebé–‹ç™ºã«ãŠã‘ã‚‹æœ€é‡è¦ãƒˆãƒ”ãƒƒã‚¯ã§ã‚ã‚‹**ã€Œèªè¨¼ã€**ã¨**ã€Œæ±ºæ¸ˆã€**ã§ã™ã€‚ã“ã®äºŒã¤ã¯ã€ã©ã‚“ãªWebã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹ä¸Šã§ã‚‚é¿ã‘ã¦ã¯é€šã‚Œãªã„é“ã§ã™ã‚ˆã­ã€‚

### 1. Auth.js (v5) ã‚’ç”¨ã„ãŸèªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…
ã€Œèªè¨¼ã¯è‡ªå‰ã§å®Ÿè£…ã™ã‚‹ãªã€ã¨ã„ã†è¨€è‘‰ã‚’ã‚ˆãèãã¾ã™ãŒã€ãã‚Œã¯ãªãœã§ã—ã‚‡ã†ã‹ï¼Ÿ Auth.jsã‚’ä½¿ã†ã“ã¨ã§ã€ã©ã‚Œã ã‘å®‰å…¨ã‹ã¤è¿…é€Ÿã«èªè¨¼æ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚ã‚‹ã®ã‹ã‚’å­¦ã³ã¾ã™ã€‚ v5ã‹ã‚‰`@auth/core`ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚ˆã‚Šæ¨™æº–ã«æº–æ‹ ã—ãŸè¨­è¨ˆã«ãªã‚Šã¾ã—ãŸã€‚ ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã®ä»•çµ„ã¿ã‹ã‚‰ã€ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€ãã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¾ã§ã€åƒ•ãŒå®Ÿéš›ã«ãƒãƒã£ãŸãƒã‚¤ãƒ³ãƒˆã‚‚äº¤ãˆãªãŒã‚‰å®Ÿè·µçš„ãªãƒã‚¦ãƒã‚¦ã‚’å¾¹åº•è§£èª¬ã—ã¾ã™ã€‚

### 2. Stripeã‚’ä½¿ç”¨ã—ãŸå•†å“ã®è³¼å…¥ï¼ˆæ±ºæ¸ˆï¼‰ãƒ•ãƒ­ãƒ¼
ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆã®è¤‡é›‘ã•ã‚’ã€StripeãŒã„ã‹ã«ã‚·ãƒ³ãƒ—ãƒ«ã«ã—ã¦ãã‚Œã‚‹ã‹ã‚’ä½“é¨“ã—ã¾ã™ã€‚å®‰å…¨ãªæ±ºæ¸ˆãƒšãƒ¼ã‚¸ï¼ˆStripe Checkoutï¼‰ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€è³¼å…¥å‡¦ç†ã®è£å´ã§è¡Œã‚ã‚Œã‚‹Webhooké€šä¿¡ã®ä»•çµ„ã¿ã€ãã—ã¦è³¼å…¥å±¥æ­´ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç®¡ç†ã™ã‚‹æ–¹æ³•ã¾ã§ã€ECã‚µã‚¤ãƒˆã®æ ¹å¹¹ã‚’ãªã™æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“åƒã‚’æ´ã¿ã¾ã™ã€‚ ç‰¹ã«Webhookã®å–ã‚Šæ‰±ã„ã¯é‡è¦ã§ã€ç½²åæ¤œè¨¼ã‚’å¿…ãšè¡Œã†ã“ã¨ã§ã€Stripeã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ä½¿ç”¨ã™ã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆãªãœã“ã‚Œã‚’é¸ã¶ã®ã‹ï¼Ÿï¼‰

ç§ãŸã¡ã¯ã€ãŸã æµè¡Œã‚Šã®æŠ€è¡“ã‚’ä½¿ã†ã®ã§ã¯ãªãã€ãã‚Œãã‚Œã®æŠ€è¡“ãŒã‚‚ãŸã‚‰ã™ä¾¡å€¤ã‚’ç†è§£ã—ãŸä¸Šã§ã€æœ€é©ãªé¸æŠã‚’è¡Œã„ã¾ã™ã€‚2å¹´ç›®ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€æŠ€è¡“é¸å®šã®ç†ç”±ã‚’è‡ªåˆ†ã®è¨€è‘‰ã§èª¬æ˜ã§ãã‚‹ã“ã¨ã¯ã€ã¨ã¦ã‚‚é‡è¦ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

*   **Next.js 15 (App Router)**
    *   React 19ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨é–‹ç™ºè€…ä½“é¨“ãŒã•ã‚‰ã«å‘ä¸Šã—ã¾ã—ãŸã€‚ ç‰¹ã«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æŒ™å‹•ãŒå¤‰æ›´ã•ã‚Œã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œãªããªã£ãŸãŸã‚ã€ã‚ˆã‚Šç›´æ„Ÿçš„ãªåˆ¶å¾¡ãŒå¯èƒ½ã§ã™ã€‚ `next dev --turbo` ãŒå®‰å®šç‰ˆã«ãªã‚Šã€é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ãŒåŠ‡çš„ã«é€Ÿããªã£ãŸã®ã‚‚å¬‰ã—ã„ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ ã“ã®è¨˜äº‹ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨Server Actionsã‚’ãƒ•ãƒ«æ´»ç”¨ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®é€£æºã‚’ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«è¨˜è¿°ã—ã¦ã„ãã¾ã™ã€‚
*   **Auth.js v5**
    *   èªè¨¼ã¨ã„ã†è¤‡é›‘ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®é«˜ã„é ˜åŸŸã‚’ã€ä¿¡é ¼ã§ãã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä»»ã›ã‚‹ã“ã¨ã§ã€ç§ãŸã¡ã¯ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚³ã‚¢ãªä¾¡å€¤å‰µé€ ã«é›†ä¸­ã§ãã¾ã™ã€‚v5ã§ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒ`auth.ts`ã«é›†ç´„ã•ã‚Œã€`handlers`ã‚„`auth`ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å½¢ã«ãªã‚Šã€ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ãŒè‰¯ããªã‚Šã¾ã—ãŸã€‚
*   **Stripe**
    *   ä¸–ç•Œæ¨™æº–ã®æ±ºæ¸ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚é–‹ç™ºè€…ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªAPIã¨é‰„å£ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã§ã€æ±ºæ¸ˆæ©Ÿèƒ½ã®å®Ÿè£…ã‚’é©šãã»ã©å®¹æ˜“ã«ã—ã¾ã™ã€‚PCI DSSæº–æ‹ ã®è²¬ä»»ã‚’Stripeã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã®ã¯ã€å€‹äººé–‹ç™ºè€…ã«ã¨ã£ã¦è¨ˆã‚ŠçŸ¥ã‚Œãªã„ãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚
*   **Prisma**
    *   TypeScriptã¨ã®ç›¸æ€§ãŒæŠœç¾¤ã®ORMï¼ˆObject-Relational Mapperï¼‰ã€‚ç›´æ„Ÿçš„ãªã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ“ä½œã—ã€å‹å®‰å…¨ãªé–‹ç™ºã‚’å®Ÿç¾ã—ã¾ã™ã€‚è³¼å…¥å±¥æ­´ãªã©ã®é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ãŸã‚ã«æ¡ç”¨ã—ã¾ã™ã€‚
*   **GitHub API ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å–å¾—**
    *   æœ¬æ ¼çš„ãªCMSã‚’å°å…¥ã›ãšã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒæ…£ã‚Œè¦ªã—ã‚“ã GitHubãƒªãƒã‚¸ãƒˆãƒªã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç®¡ç†ã—ã¾ã™ã€‚`git`ã«ã‚ˆã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã®æ©æµã‚’å—ã‘ãªãŒã‚‰ã€Markdownã§å¿«é©ã«åŸ·ç­†ã§ãã‚‹ãƒ•ãƒ­ãƒ¼ã¯ã€æŠ€è¡“ãƒ–ãƒ­ã‚°ã¨ã®ç›¸æ€§ã‚‚æŠœç¾¤ã§ã™ã€‚
*   **TypeScript**
    *   è¨€ã‚ãšã¨çŸ¥ã‚ŒãŸã€ç¾ä»£ã®Webé–‹ç™ºã«ãŠã‘ã‚‹å¿…é ˆè¨€èªã€‚å‹ã«ã‚ˆã‚‹é™çš„è§£æãŒã€å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã‚’æœªç„¶ã«é˜²ãã€ã‚³ãƒ¼ãƒ‰ã®ä¿å®ˆæ€§ã‚’é£›èºçš„ã«å‘ä¸Šã•ã›ã¾ã™ã€‚ã‚‚ã†JavaScriptã ã‘ã®ä¸–ç•Œã«ã¯æˆ»ã‚Œã¾ã›ã‚“â€¦ï¼
*   **Tailwind CSS & shadcn/ui**
    *   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®CSSãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã€é©æ–°çš„ãªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹ç¯‰ãƒ„ãƒ¼ãƒ«ã€‚ãƒ‡ã‚¶ã‚¤ãƒ³ã®è‡ªç”±åº¦ã¨é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ä¸¡ç«‹ã—ã€ã€Œè‡ªåˆ†ã®ã‚‚ã®ã€ã¨ã—ã¦æ‰€æœ‰ãƒ»ç®¡ç†ã§ãã‚‹UIã‚’æ§‹ç¯‰ã§ãã‚‹ã®ãŒé­…åŠ›ã§ã™ã€‚

ã•ã‚ã€æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿ
ã“ã“ã‹ã‚‰ã€æœ¬æ ¼çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã®ä¸–ç•Œã¸æ·±ããƒ€ã‚¤ãƒ–ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

---

### ç¬¬1ç« : ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­è¨ˆã¨ç’°å¢ƒæ§‹ç¯‰

ä½•äº‹ã‚‚æœ€åˆãŒè‚å¿ƒã§ã™ã€‚ã¾ãšã¯ã€ã“ã‚Œã‹ã‚‰ä½œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ä½“åƒã‚’æŠŠæ¡ã—ã€é–‹ç™ºã‚’å§‹ã‚ã‚‹ãŸã‚ã®åœŸå°ã‚’å›ºã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

#### 1-1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒˆã‚’è¨ªã‚Œã¦ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è³¼å…¥ã™ã‚‹ã¾ã§ã€ãƒ‡ãƒ¼ã‚¿ã¯ã©ã®ã‚ˆã†ã«æµã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿä»¥ä¸‹ã®å›³ï¼ˆMermaidè¨˜æ³•ï¼‰ã§å…¨ä½“åƒã‚’æ´ã¿ã¾ã—ã‚‡ã†ã€‚

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant App as Next.jsã‚¢ãƒ—ãƒª
    participant DB as Prisma (DB)
    participant GitHub as GitHub API
    participant Stripe

    User->>App: GitHubã§ãƒ­ã‚°ã‚¤ãƒ³
    App->>DB: èªè¨¼æƒ…å ±ã‚’ä¿å­˜ (Auth.js)
    DB-->>App: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
    App-->>User: ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¡¨ç¤º

    User->>App: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸€è¦§/è©³ç´°ã‚’é–²è¦§
    App->>GitHub: Markdownã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
    GitHub-->>App: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
    App-->>User: ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º

    User->>App: è³¼å…¥ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ (Server Action)
    App->>Stripe: æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    Stripe-->>App: æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã®URLã‚’è¿”ã™
    App-->>User: Stripeæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

    User->>Stripe: ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ãƒ»æ±ºæ¸ˆ
    Stripe-->>User: æ±ºæ¸ˆå®Œäº†ç”»é¢

    Stripe-)App: Webhookã§æ±ºæ¸ˆå®Œäº†ã‚’é€šçŸ¥
    App->>App: ç½²åã‚’æ¤œè¨¼ã—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ­£å½“æ€§ã‚’ç¢ºèª
    App->>DB: è³¼å…¥å±¥æ­´ã‚’ä¿å­˜ (ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ã©ã®å•†å“ã‹)
    DB-->>App: ä¿å­˜æˆåŠŸ
    App-)Stripe: 200 OKãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

    User->>App: è³¼å…¥æ¸ˆã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹
    App->>DB: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³¼å…¥å±¥æ­´ã‚’ç¢ºèª
    DB-->>App: è³¼å…¥æ¸ˆã¿æƒ…å ±ã‚’è¿”ã™
    App->>GitHub: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
    GitHub-->>App: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
    App-->>User: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å…¨æ–‡ã‚’è¡¨ç¤º
```

#### 1-2. é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

`create-next-app`ã‹ã‚‰å§‹ã‚ã€å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€å„ç¨®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã¾ã™ã€‚

```bash
# Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ (æœ€æ–°ç‰ˆã‚’ä½¿ã„ã¾ã™)
npx create-next-app@latest nextjs-contents-market --typescript --tailwind --eslint

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•
cd nextjs-contents-market

# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# Auth.jsã¨Prismaã‚¢ãƒ€ãƒ—ã‚¿ã€Prismaæœ¬ä½“ã€Stripe
npm install next-auth@beta @auth/prisma-adapter prisma stripe

# é–‹ç™ºç’°å¢ƒç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
npm install -D @types/node ts-node

# Prismaã®åˆæœŸåŒ–
npx prisma init

# shadcn/uiã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (ã“ã‚ŒãŒã‚ã‚‹ã¨UIå®Ÿè£…ãŒçˆ†é€Ÿã«ãªã‚Šã¾ã™)
npx shadcn-ui@latest init
```

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€`tailwind.config.ts`ã®èª¿æ•´ã€`components.json`ã®ç¢ºèªã€ãã—ã¦æœ€ã‚‚é‡è¦ãª`prisma/schema.prisma`ã®è¨­è¨ˆã‚’ä¸å¯§ã«è¡Œã„ã¾ã™ã€‚`User`, `Account`, `Session`ã¯Auth.jsã«å¿…é ˆã®ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚ ã“ã‚Œã«åŠ ãˆã¦ã€ç§ãŸã¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ ¸ã¨ãªã‚‹`Purchase`ï¼ˆè³¼å…¥å±¥æ­´ï¼‰ã€`Post`ï¼ˆè¨˜äº‹ï¼‰ã€`Book`ï¼ˆæœ¬ï¼‰ã¨ã„ã£ãŸãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã—ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ„ã‚“ã§ã„ãã¾ã™ã€‚

---

### ç¬¬2ç« : Auth.jsã«ã‚ˆã‚‹èªè¨¼åŸºç›¤ã®æ§‹ç¯‰

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ã¦ã®æ©Ÿèƒ½ã®åœŸå°ã¨ãªã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚v5ã«ãªã£ã¦ã€è¨­å®šãŒã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã—ãŸã€‚

#### 2-1. GitHub OAuth Appã®ä½œæˆã¨ç’°å¢ƒå¤‰æ•°è¨­å®š

ã¾ãšã¯GitHubã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€é–‹ç™ºè€…è¨­å®šã‹ã‚‰æ–°ã—ã„OAuth Appã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã“ã§å–å¾—ã—ãŸ`Client ID`ã¨`Client Secret`ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«ä½œæˆã™ã‚‹`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚Auth.js v5ã‹ã‚‰ã¯ã€ç’°å¢ƒå¤‰æ•°ã‚’`AUTH_`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§å‘½åã™ã‚‹ã¨è‡ªå‹•ã§èª­ã¿è¾¼ã‚“ã§ãã‚Œã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã€‚

```.env.local
# .env.local

# GitHub Provider
AUTH_GITHUB_ID="gho_..."
AUTH_GITHUB_SECRET="..."

# Auth.js Core
AUTH_SECRET="openssl rand -base64 32 ã§ç”Ÿæˆã—ãŸãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—"
AUTH_URL="http://localhost:3000"

# Database
DATABASE_URL="postgresql://user:password@host:port/database?sslmode=require"
```

#### 2-2. èªè¨¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨APIãƒ«ãƒ¼ãƒˆã®ä½œæˆ

`auth.ts`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆï¼ˆã¾ãŸã¯`src/`ï¼‰ã«ä½œæˆã—ã€Auth.jsã®ä¸­æ ¸ã¨ãªã‚‹è¨­å®šã‚’è¨˜è¿°ã—ã¾ã™ã€‚`PrismaAdapter`ã‚’ä½¿ã„ã€èªè¨¼æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨é€£æºã•ã›ã¾ã™ã€‚

```typescript:auth.ts
import NextAuth from "next-auth";
import GitHub from "next-auth/providers/github";
import { PrismaAdapter } from "@auth/prisma-adapter";
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: PrismaAdapter(prisma),
  providers: [GitHub], // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰IDã¨SecretãŒè‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹
  session: {
    strategy: "jwt", // JWTã‚’ä½¿ã†ã®ãŒãƒ¢ãƒ€ãƒ³ãªã‚¹ã‚¿ã‚¤ãƒ«ã§ã™
  },
  callbacks: {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¿½åŠ ã™ã‚‹
    session({ session, token }) {
      if (token.sub && session.user) {
        session.user.id = token.sub;
      }
      return session;
    },
  },
});
```
æ¬¡ã«ã€ã“ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®APIãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```typescript:app/api/auth/[...nextauth]/route.ts
import { handlers } from "@/auth"; // auth.tsã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
export const { GET, POST } = handlers;
```
v5ã§ã¯ã“ã‚Œã ã‘ã§APIãƒ«ãƒ¼ãƒˆã®å®Œæˆã§ã™ã€‚ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã—ãŸã­ã€‚

#### 2-3. ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…

ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—æ–¹æ³•ãŒç•°ãªã‚Šã¾ã™ã€‚

*   **ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: `auth()` ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚
*   **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: å¾“æ¥é€šã‚Š `useSession` ãƒ•ãƒƒã‚¯ã‚’ä½¿ã„ã¾ã™ãŒã€Layoutã§ `<SessionProvider>` ã§ãƒ©ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`shadcn/ui`ã®`Avatar`ã‚„`DropdownMenu`ã‚’æ´»ç”¨ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤ºãŒå¤‰ã‚ã‚‹ãƒ¢ãƒ€ãƒ³ãªUIã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚µã‚¯ãƒƒã¨æ§‹ç¯‰ã—ã¾ã—ã‚‡ã†ã€‚

---

### ç¬¬3ç« : Stripeã«ã‚ˆã‚‹æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒã‚¿ã‚¤ã‚ºã®å¿ƒè‡“éƒ¨ã€æ±ºæ¸ˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚åˆã‚ã¦è§¦ã‚‹ã¨é›£ã—ãã†ã«æ„Ÿã˜ã¾ã™ãŒã€Stripeã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æœ¬å½“ã«å„ªç§€ã§ã™ã€‚

#### 3-1. Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨å•†å“ã®è¨­å®š

Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–ã—ã€ãƒ†ã‚¹ãƒˆç”¨ã®APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦`.env.local`ã«è¨­å®šã—ã¾ã™ã€‚ã¾ãŸã€è²©å£²ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å¯¾å¿œã™ã‚‹ã€Œå•†å“ï¼ˆProductï¼‰ã€ã¨ã€Œä¾¡æ ¼ï¼ˆPriceï¼‰ã€ã‚’Stripeä¸Šã§ç™»éŒ²ã—ã€ãã®`price_...`ã‹ã‚‰å§‹ã¾ã‚‹ä¾¡æ ¼IDã‚’æ§ãˆã¦ãŠãã¾ã™ã€‚ã“ã‚ŒãŒå•†å“ã¨Stripeã‚’çµã³ã¤ã‘ã‚‹éµã«ãªã‚Šã¾ã™ã€‚

#### 3-2. è³¼å…¥ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£… (Server Actions)

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³¼å…¥ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã®å‡¦ç†ã‚’ã€Server Actionsã§å®Ÿè£…ã—ã¾ã™ã€‚ã“ã®Actionã¯ã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã€Stripeã®æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã¾ã™ã€‚APIãƒ«ãƒ¼ãƒˆã‚’åˆ¥é€”ä½œæˆã™ã‚‹å¿…è¦ãŒãªã„ã®ãŒServer Actionsã®å¼·åŠ›ãªç‚¹ã§ã™ã€‚

```typescript:app/actions/stripe.ts
"use server";

import { auth } from "@/auth";
import { stripe } from "@/lib/stripe";
import { redirect } from "next/navigation";

// å¼•æ•°ã¨ã—ã¦ã€ã©ã®å•†å“(ä¾¡æ ¼ID)ã‚’è³¼å…¥ã™ã‚‹ã‹ã‚’å—ã‘å–ã‚‹
export async function createCheckoutSession(priceId: string) {
  const session = await auth();
  if (!session?.user?.id) {
    throw new Error("User not authenticated");
  }

  const checkoutSession = await stripe.checkout.sessions.create({
    mode: "payment",
    line_items: [{ price: priceId, quantity: 1 }],
    success_url: `${process.env.AUTH_URL}/payment/success`,
    cancel_url: `${process.env.AUTH_URL}/payment/cancel`,
    // Webhookã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨å•†å“æƒ…å ±ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«metadataã«å«ã‚ã‚‹
    metadata: {
      userId: session.user.id,
      priceId: priceId,
    },
  });

  if (!checkoutSession.url) {
    throw new Error("Could not create checkout session");
  }

  redirect(checkoutSession.url);
}
````metadata`ã«`userId`ã¨`priceId`ã‚’è©°ã‚ã‚‹ã“ã¨ãŒã€å¾Œã®Webhookå‡¦ç†ã§éå¸¸ã«é‡è¦ã«ãªã‚Šã¾ã™ã€‚

#### 3-3. Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ§‹ç¯‰

Stripeã‹ã‚‰ã®éåŒæœŸãªé€šçŸ¥ã‚’å—ã‘å–ã‚‹ãŸã‚ã®APIãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚Stripeã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæœ¬ç‰©ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€å¿…ãšç½²åã‚’æ¤œè¨¼ã—ã¾ã™ã€‚ ã“ã®æ¤œè¨¼ã‚’æ€ ã‚‹ã¨ã€æ‚ªæ„ã®ã‚ã‚‹ç¬¬ä¸‰è€…ãŒè³¼å…¥å®Œäº†ã‚’å½è£…ã§ãã¦ã—ã¾ã†ãŸã‚ã€çµ¶å¯¾ã«å¿…è¦ã§ã™ã€‚

`checkout.session.completed`ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã£ãŸã‚‰ã€`metadata`ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨å•†å“IDã‚’å–ã‚Šå‡ºã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è³¼å…¥å±¥æ­´ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚

```typescript:app/api/webhooks/stripe/route.ts
import { NextRequest, NextResponse } from "next/server";
import { stripe } from "@/lib/stripe";
import { prisma } from "@/lib/prisma";
import Stripe from "stripe";

const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET!;

export async function POST(req: NextRequest) {
  const buf = await req.text();
  const sig = req.headers.get("stripe-signature")!;

  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(buf, sig, webhookSecret);
  } catch (err) {
    console.error("Webhook signature verification failed.", err);
    return NextResponse.json({ error: "Webhook error" }, { status: 400 });
  }

  if (event.type === "checkout.session.completed") {
    const session = event.data.object as Stripe.Checkout.Session;
    const { userId, priceId } = session.metadata!;

    // DBã«è³¼å…¥å±¥æ­´ã‚’ä¿å­˜
    // TODO: priceIdã‹ã‚‰å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„IDã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒå¿…è¦
    await prisma.purchase.create({
      data: {
        userId: userId,
        stripePriceId: priceId,
        // contentId: "..."
      },
    });
  }

  return NextResponse.json({ received: true });
}
```
Stripeã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã—ã¦ã€Webhookãƒãƒ³ãƒ‰ãƒ©ã¯è¿…é€Ÿã«`200`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ é‡ã„å‡¦ç†ã¯éåŒæœŸã§è¡Œã†ã®ãŒç†æƒ³ã§ã™ã€‚

---

### ç¬¬4ç« : ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã¨è³¼å…¥åˆ¶å¾¡ã®å®Ÿè£…

èªè¨¼ã¨æ±ºæ¸ˆã€äºŒã¤ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’é€£æºã•ã›ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚ã“ã‚Œã“ããŒã€ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ã§ã‚ã‚Šã€è…•ã®è¦‹ã›æ‰€ã§ã™ï¼

#### 4-1. GitHubã‹ã‚‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å–å¾—ãƒ­ã‚¸ãƒƒã‚¯

`lib`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã©ã«ã€GitHub APIã‚’å©ã„ã¦ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã€ãƒ‘ãƒ¼ã‚¹ã™ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚`gray-matter`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã¨ã€Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«æ›¸ã‹ã‚ŒãŸfrontmatterï¼ˆYAMLå½¢å¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰ã¨æœ¬æ–‡ã‚’ç°¡å˜ã«åˆ†é›¢ã§ãã¾ã™ã€‚

```markdown:example-post.md
---
title: "åˆã‚ã¦ã®Server Actions"
priceId: "price_xxxxxxxxxxxxxx" # ã“ã®è¨˜äº‹ãŒæœ‰æ–™ã®å ´åˆã€Stripeã®ä¾¡æ ¼IDã‚’æŒ‡å®š
---

## ã“ã“ã‹ã‚‰æœ¬æ–‡ãŒå§‹ã¾ã‚Šã¾ã™

Server Actionsã¯...
```ã“ã®`priceId`ã®æœ‰ç„¡ã§ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç„¡æ–™ã‹æœ‰æ–™ã‹ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚

#### 4-2. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è©³ç´°ãƒšãƒ¼ã‚¸ã®æ§‹ç¯‰

Next.jsã®å‹•çš„ãƒ«ãƒ¼ãƒˆ (`app/posts/[slug]/page.tsx`ãªã©) ã‚’ä½¿ã£ã¦ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è©³ç´°ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã¯ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å…¨ã¦ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œçµã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### 4-3. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã®æ ¸å¿ƒ

ãƒšãƒ¼ã‚¸ã®ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ã€ä»¥ä¸‹ã®å‡¦ç†ã‚’é †ç•ªã«è¡Œã„ã¾ã™ã€‚ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è€ƒãˆã‚‹ã®ãŒã€ä¸€ç•ªæ¥½ã—ã„ã¨ã“ã‚ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

1.  URLã®`slug`ã‹ã‚‰ã€è¡¨ç¤ºã™ã¹ãã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’GitHubã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚
2.  `auth()`ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ã£ã¦ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰`null`ãŒè¿”ã‚Šã¾ã™ï¼‰
3.  å–å¾—ã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®frontmatterã«`priceId`ãŒã‚ã‚‹ã‹ï¼ˆï¼æœ‰æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ï¼‰ã‚’ç¢ºèªã—ã¾ã™ã€‚
4.  ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæœ‰æ–™ã®å ´åˆã€DBã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„IDï¼ˆã¾ãŸã¯`priceId`ï¼‰ã§`Purchase`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¤œç´¢ã—ã€è³¼å…¥æ¸ˆã¿ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```typescript:app/posts/[slug]/page.tsx
import { auth } from "@/auth";
import { getPostBySlug } from "@/lib/github";
import { prisma } from "@/lib/prisma";
import { MarkdownContent } from "@/components/markdown-content";
import { PurchaseButton } from "@/components/purchase-button";

export default async function PostPage({ params }: { params: { slug: string } }) {
  const { slug } = params;
  const session = await auth(); // 1. èªè¨¼æƒ…å ±ã‚’å–å¾—

  const post = await getPostBySlug(slug); // 2. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
  const isPaidContent = !!post.frontmatter.priceId; // 3. æœ‰æ–™ã‹åˆ¤å®š

  let isPurchased = false;
  if (isPaidContent && session?.user?.id) {
    const purchase = await prisma.purchase.findFirst({ // 4. è³¼å…¥å±¥æ­´ã‚’ç¢ºèª
      where: {
        userId: session.user.id,
        stripePriceId: post.frontmatter.priceId,
      },
    });
    isPurchased = !!purchase;
  }

  const canViewContent = !isPaidContent || isPurchased;

  return (
    <article>
      <h1>{post.frontmatter.title}</h1>
      {canViewContent ? (
        <MarkdownContent content={post.content} />
      ) : (
        <div>
          <p>ã“ã®è¨˜äº‹ã¯æœ‰æ–™ã§ã™ã€‚ç¶šãã‚’èª­ã‚€ã«ã¯è³¼å…¥ãŒå¿…è¦ã§ã™ã€‚</p>
          {/* è³¼å…¥ãƒœã‚¿ãƒ³ã¯Server Actionã‚’å‘¼ã³å‡ºã™ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */}
          <PurchaseButton priceId={post.frontmatter.priceId} />
        </div>
      )}
    </article>
  );
}
```
ã“ã®æ¡ä»¶åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€noteã‚„Zennã®ã‚ˆã†ãªã‚»ã‚­ãƒ¥ã‚¢ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„è²©å£²ãŒå®Ÿç¾ã§ãã‚‹ã‚ã‘ã§ã™ã€‚

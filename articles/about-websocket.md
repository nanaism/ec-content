---
title: "Socket.ioã¨ã¯ï¼ŸNext.jsã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’å®Ÿç¾ã™ã‚‹åŸºç¤çŸ¥è­˜"
emoji: "ğŸ“¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "websocket", "socketio", "realtime"]
published: true
---

## ã¯ã˜ã‚ã«

ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã€å…±åŒç·¨é›†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€æ ªä¾¡ã®ãƒ©ã‚¤ãƒ–é…ä¿¡â€¦ ã“ã®ã‚ˆã†ãªã€Œãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã€ãªæ©Ÿèƒ½ã‚’æŒã¤Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã£ã¦ã¿ãŸã„ã¨æ€ã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

å¾“æ¥ã®WebæŠ€è¡“ã§ã‚ã‚‹HTTPé€šä¿¡ã¯ã€åŸºæœ¬çš„ã«ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒè¦æ±‚ã—ã€ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã™ã‚‹ã€ã¨ã„ã†ä¸€æ–¹å‘ã®ã‚„ã‚Šå–ã‚ŠãŒåŸºæœ¬ã§ã—ãŸã€‚ãã®ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼å´ã§èµ·ããŸå¤‰åŒ–ã‚’å³åº§ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ä¼ãˆã‚‹ã®ãŒè‹¦æ‰‹ã§ã™ã€‚

ã“ã®èª²é¡Œã‚’è§£æ±ºã—ã€Webä¸Šã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªä½“é¨“ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®é‡è¦ãªæŠ€è¡“ãŒ **WebSocket** ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€WebSocketãŒã©ã®ã‚ˆã†ãªæŠ€è¡“ã§ã€ãªãœå¿…è¦ãªã®ã‹ã€ãã—ã¦Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã©ã†ã‚„ã£ã¦åˆ©ç”¨ã™ã‚‹ã®ã‹ã€ãã®åŸºæœ¬ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¾ã™ã€‚

## WebSocket ã¨ã¯ï¼Ÿ

WebSocketã¨ã¯ã€ä¸€è¨€ã§ã„ã†ã¨ **ã€ŒWebãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã¨ã‚µãƒ¼ãƒãƒ¼ã®é–“ã§ã€åŒæ–¹å‘ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã®æŠ€è¡“ä»•æ§˜ï¼ˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼‰ã€** ã§ã™ã€‚

é›»è©±ã«ä¾‹ãˆã‚‹ã¨éå¸¸ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

*   **å¾“æ¥ã®HTTPé€šä¿¡**: ã€Œæ‰‹ç´™ã®ã‚„ã‚Šå–ã‚Šã€
    *   ç”¨ä»¶ãŒã‚ã‚‹ãŸã³ã«ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ‰‹ç´™ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ã‚’æ›¸ãã€ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚Šã¾ã™ã€‚
    *   ã‚µãƒ¼ãƒãƒ¼ã¯ãã®æ‰‹ç´™ã‚’èª­ã‚“ã§ã€è¿”äº‹ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰ã‚’æ›¸ã„ã¦é€ã‚Šè¿”ã—ã¾ã™ã€‚
    *   ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰è‡ªç™ºçš„ã«æ‰‹ç´™ã‚’é€ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚å¸¸ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ‰‹ç´™ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

*   **WebSocket**: ã€Œé›»è©±å›ç·šã€
    *   æœ€åˆã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã«é›»è©±ã‚’ã‹ã‘ã€ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã™ã‚‹ã¨ã€æ¥ç¶šï¼ˆé›»è©±å›ç·šï¼‰ãŒç¢ºç«‹ã•ã‚Œã¾ã™ã€‚
    *   ä¸€åº¦æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã‚Œã°ã€ãã®å›ç·šã¯é–‹ã„ãŸã¾ã¾ã«ãªã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®ã©ã¡ã‚‰ã‹ã‚‰ã§ã‚‚ã€ã„ã¤ã§ã‚‚å¥½ããªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä¼šè©±ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ï¼‰ã§ãã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€WebSocketã¯ä¸€åº¦æ¥ç¶šã‚’ç¢ºç«‹ã™ã‚‹ã¨ã€ãã®é€šä¿¡è·¯ï¼ˆã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’ç¶­æŒã—ç¶šã‘ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€HTTPã®ã‚ˆã†ã«æ¯å›æ¥ç¶šã‚’ç¢ºç«‹ã—ç›´ã™æ‰‹é–“ãŒãªãã€ä½é…å»¶ã§åŠ¹ç‡çš„ãªåŒæ–¹å‘é€šä¿¡ãŒå®Ÿç¾ã§ãã‚‹ã®ã§ã™ã€‚

### WebSocketã®ä¸»ãªãƒ¡ãƒªãƒƒãƒˆ

1.  **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§**: ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸéš›ã€å³åº§ã«å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œãƒ—ãƒƒã‚·ãƒ¥ã€ã§ãã¾ã™ã€‚ãƒãƒ£ãƒƒãƒˆã®æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ã€ã‚¹ãƒãƒ¼ãƒ„ã®è©¦åˆé€Ÿå ±ãªã©ã«æœ€é©ã§ã™ã€‚
2.  **åŒæ–¹å‘é€šä¿¡**: ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå¯¾ç­‰ãªç«‹å ´ã§ã€ã„ã¤ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚Šåˆãˆã¾ã™ã€‚
3.  **åŠ¹ç‡æ€§**: é€šä¿¡ã®ãŸã³ã«é€ä¿¡ã•ã‚Œã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒHTTPã«æ¯”ã¹ã¦éå¸¸ã«å°ã•ãã€é€šä¿¡ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼ˆç„¡é§„ï¼‰ãŒå°‘ãªã„ãŸã‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„ã‚µãƒ¼ãƒãƒ¼ã¸ã®è² è·ã‚’è»½æ¸›ã§ãã¾ã™ã€‚

## Next.js ã§ WebSocket ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ï¼Ÿ

Next.jsè‡ªä½“ã¯ã€HTTPã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã®æ©Ÿèƒ½ãŒä¸­å¿ƒã§ã‚ã‚Šã€WebSocketã‚µãƒ¼ãƒãƒ¼ã®æ©Ÿèƒ½ã‚’æ¨™æº–ã§ã¯å†…è”µã—ã¦ã„ã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§WebSocketã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€å°‘ã—å·¥å¤«ãŒå¿…è¦ã§ã™ã€‚

æœ€ã‚‚ä¸€èˆ¬çš„ã§å®‰å®šã—ãŸæ–¹æ³•ã¯ã€**Next.jsã®Webã‚µãƒ¼ãƒãƒ¼ã¨ã¯åˆ¥ã«ã€å°‚ç”¨ã®WebSocketã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦é€£æºã•ã›ã‚‹**ã“ã¨ã§ã™ã€‚

ã“ã“ã§ã¯ã€äººæ°—ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ `Socket.IO` ã‚’ä½¿ã£ãŸåŸºæœ¬çš„ãªå®Ÿè£…æ‰‹é †ã®æ¦‚è¦ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚`Socket.IO`ã¯ã€WebSocketã‚’ã‚ˆã‚Šç°¡å˜ã«ã€ãã—ã¦å®‰å®šã—ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ä¸¡æ–¹ã§åˆ©ç”¨ã§ãã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—1: å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

WebSocketã‚µãƒ¼ãƒãƒ¼ç”¨ã«`socket.io`ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã«`socket.io-client`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
# ã‚µãƒ¼ãƒãƒ¼ç”¨ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã‚’ä¸¡æ–¹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install socket.io socket.io-client
```

### ã‚¹ãƒ†ãƒƒãƒ—2: WebSocketã‚µãƒ¼ãƒãƒ¼ã®ä½œæˆ

Next.jsã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã¯åˆ¥ã«ã€WebSocketé€šä¿¡ã‚’å°‚é–€ã«æ‰±ã†ãŸã‚ã®ã‚·ãƒ³ãƒ—ãƒ«ãªNode.jsã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¾ã™ã€‚ï¼ˆä¾‹: `websocket-server/index.js`ï¼‰

```javascript:websocket-server/index.js
// Expressãªã©ã®HTTPã‚µãƒ¼ãƒãƒ¼ã¨é€£æºã•ã›ã‚‹ã®ãŒä¸€èˆ¬çš„
const { createServer } = require("http");
const { Server } = require("socket.io");

const httpServer = createServer();
const io = new Server(httpServer, {
  cors: {
    origin: "http://localhost:3000", // Next.jsã‚¢ãƒ—ãƒªã®URL
    methods: ["GET", "POST"]
  }
});

io.on("connection", (socket) => {
  console.log("A user connected:", socket.id);

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰'message'ã¨ã„ã†ã‚¤ãƒ™ãƒ³ãƒˆåã§ãƒ‡ãƒ¼ã‚¿ãŒé€ã‚‰ã‚Œã¦ããŸæ™‚ã®å‡¦ç†
  socket.on("message", (data) => {
    console.log("Message received:", data);
    // å…¨ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«'message'ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹
    io.emit("message", data);
  });

  socket.on("disconnect", () => {
    console.log("User disconnected:", socket.id);
  });
});

const PORT = 3001; // Next.jsã‚¢ãƒ—ãƒªã¨ã¯åˆ¥ã®ãƒãƒ¼ãƒˆã§èµ·å‹•
httpServer.listen(PORT, () => {
  console.log(`WebSocket server listening on port ${PORT}`);
});
```
ã“ã®ã‚µãƒ¼ãƒãƒ¼ã‚’ `node websocket-server/index.js` ã®ã‚ˆã†ã«ã—ã¦èµ·å‹•ã—ã¦ãŠãã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—3: Next.jsã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ¥ç¶šã™ã‚‹

Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ã§ã€å…ˆã»ã©ç«‹ã¡ä¸Šã’ãŸWebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã€ãƒ‡ãƒ¼ã‚¿ã®é€å—ä¿¡ã‚’è¡Œã„ã¾ã™ã€‚

```tsx:app/components/Chat.tsx
"use client"

import { useEffect, useState } from "react"
import io, { Socket } from "socket.io-client"

// ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®Socketã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¸€åº¦ã ã‘ä½œæˆ
const socket: Socket = io("http://localhost:3001");

export default function Chat() {
  const [message, setMessage] = useState("");
  const [chat, setChat] = useState<string[]>([]);

  useEffect(() => {
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰'message'ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãŸæ™‚ã®å‡¦ç†
    socket.on("message", (data) => {
      setChat((prevChat) => [...prevChat, data]);
    });

    // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸæ™‚ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    return () => {
      socket.off("message");
    };
  }, []);

  const sendMessage = (e: React.FormEvent) => {
    e.preventDefault();
    if (message) {
      // ã‚µãƒ¼ãƒãƒ¼ã«'message'ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
      socket.emit("message", message);
      setMessage("");
    }
  };

  return (
    <div>
      <ul>
        {chat.map((msg, index) => (
          <li key={index}>{msg}</li>
        ))}
      </ul>
      <form onSubmit={sendMessage}>
        <input
          type="text"
          value={message}
          onChange={(e) => setMessage(e.target.value)}
        />
        <button type="submit">é€ä¿¡</button>
      </form>
    </div>
  );
}
```

### æ³¨æ„ç‚¹: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§ã®åˆ©ç”¨
Vercelã®ã‚ˆã†ãªã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã€é•·æ™‚é–“æ¥ç¶šã‚’ç¶­æŒã™ã‚‹WebSocketã‚µãƒ¼ãƒãƒ¼ã‚’å‹•ã‹ã™ã“ã¨ã¯é›£ã—ã„ã€ã‚ã‚‹ã„ã¯è¿½åŠ ã®æ§‹æˆãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
ãã®å ´åˆã¯ã€**Pusher**ã‚„**Ably**ã¨ã„ã£ãŸã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹å¤–éƒ¨ã®SaaSã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒç¾å®Ÿçš„ã§ç°¡å˜ãªè§£æ±ºç­–ã¨ãªã‚Šã¾ã™ã€‚

